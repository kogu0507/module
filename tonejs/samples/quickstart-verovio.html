<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>Tonejs v1 / Quickstart (Verovio)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body {
            font-family: system-ui, sans-serif;
            margin: 16px;
        }

        #score {
            border: 1px solid #ddd;
            min-height: 160px;
            padding: 8px;
            margin-top: 8px;
        }

        button {
            margin-right: 8px;
        }

        .note {
            color: #555;
            font-size: .9em;
        }
    </style>
</head>

<body>
    <h1>Quickstart: Verovio → Tone.js（全再生）</h1>
    <p class="note">手順: SVG表示 → MIDI取得 → Manager setup → バインド → 再生</p>

    <div>
        <label>MEI URL:
            <input id="meiUrl" type="text" size="80"
                value="https://cdn.jsdelivr.net/gh/kogu0507/dev@main/0-temp/sample1.mei" />
        </label>
        <button id="btnShow">SVG表示</button>
        <button id="btnMidi">MIDI取得</button>
        <span id="meiStatus" class="note"></span>
    </div>
    <div id="score"></div>

    <hr />
    <div>
        <button id="btnSetup">Manager setup（synth）</button>
        <button id="btnBind">MIDIをバインド</button>
        <button id="btnPlay">全再生</button>
        <button id="btnStop">停止</button>
        <span id="setupStatus" class="note"></span>
    </div>

    <script type="module">
        import { VerovioManager } from "https://cdn.jsdelivr.net/gh/kogu0507/module@v2.4.0/verovio/verovio-manager.min.js";
        import { TonejsManager } from "../manager/tonejs-manager.js";

        const vrv = new VerovioManager();
        const mgr = new TonejsManager();

        const $ = (id) => document.getElementById(id);
        const meiUrlEl = $('meiUrl');
        const meiStatus = $('meiStatus');
        const setupStatus = $('setupStatus');


        // オプション設定
        const baseOptions = {
            svgViewBox: false,
            adjustPageHeight: true,
            adjustPageWidth: true,
            breaks: 'encoded',
            spacingStaff: 5,
            spacingSystem: 15,
            footer: 'none',
        };

        const svgViewBox = {
            ...baseOptions,
            svgViewBox: true,
            pageMarginTop: 0,
            pageMarginRight: 0,
            pageMarginBottom: 0,
            pageMarginLeft: 0,
        };

        let midiBuf = null;


        $('btnShow').addEventListener('click', async () => {
            meiStatus.textContent = '読み込み中…';
            await vrv.initialize();
            vrv.setRenderOptions(svgViewBox);
            // await vrv.displaySvgFromUrl(meiUrlEl.value.trim(), 'score', { page: 1 });
            await vrv.displaySvgFromUrl(meiUrlEl.value.trim(), 'score', { page: 1, measureRange: ''  });
            
            meiStatus.textContent = 'SVG OK';
        });

        $('btnMidi').addEventListener('click', async () => {
            meiStatus.textContent = 'MIDI取得中…';
            midiBuf = await vrv.getMidiFromUrl(meiUrlEl.value.trim());
            meiStatus.textContent = `MIDI OK (${midiBuf.byteLength} bytes)`;
        });

        $('btnSetup').addEventListener('click', async () => {
            await mgr.setup({
                instrument: 'synth',
                onPlayStart: () => console.log('▶ onPlayStart'),
                onPlayEnd: () => console.log('■ onPlayEnd'),
            });
            setupStatus.textContent = 'setup OK';
        });

        $('btnBind').addEventListener('click', async () => {
            if (!midiBuf) return alert('先にMIDI取得してください');
            await mgr.loadFromVerovio(midiBuf);
            setupStatus.textContent = 'MIDIバインド OK';
        });

        $('btnPlay').addEventListener('click', () => mgr.play());
        $('btnStop').addEventListener('click', () => mgr.stop());
    </script>
</body>

</html>