<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Range & Core Processor Test</title>
</head>
<body>
    <h1>プレイレンジとコアプロセッサーの連携テスト</h1>
    <p>このページでは、Verovioから取得したMIDIデータからテンポと拍子記号を抽出し、それを使って小節と秒数の変換が正しく行われるかテストします。</p>
    <button id="startButton">テスト開始</button>

    <hr>
    
    <h2>楽譜表示</h2>
    <div id="scoreSvgContainer"></div>

    <hr>

    <h2>MIDIデータ情報</h2>
    <p><strong>BPM:</strong> <span id="bpmInfo">...</span></p>
    <p><strong>拍子記号:</strong> <span id="timeSignatureInfo">...</span></p>

    <hr>

    <h2>時間変換テスト</h2>
    <p>MEIデータの3小節目（beatsPerMeasure: <span id="bpmFromCore">...</span>）の秒数を計算します。</p>
    <button id="convertButton">3小節目の秒数を計算</button>
    <p><strong>変換結果:</strong> <span id="resultInfo">...</span></p>

    <pre id="log"></pre>

    <script type="module">
        import { VerovioManager } from 'https://cdn.jsdelivr.net/gh/kogu0507/module@v2.9.0/verovio/verovio-manager.js';
        import { loadToneJs } from '../core/loader.js';
        import { initToneAudio } from '../core/setup.js';
        import { processMidiData } from '../processor/core-processor.js';
        import { measureAndBeatToSeconds, getPlayRangeInSeconds } from '../core/play-range.js';

        const verovioManager = new VerovioManager();
        const meiUrl = "https://kogu0507.github.io/dev/0-temp/sample.mei";

        const startButton = document.getElementById('startButton');
        const convertButton = document.getElementById('convertButton');
        const logElement = document.getElementById('log');

        let timeSignatureFromCore = { beatsPerMeasure: 4 };

        function log(message) {
            console.log(message);
            logElement.textContent += message + '\n';
        }

        async function initialize() {
            log('テストに必要なモジュールをロードしています...');
            await loadToneJs();
            await initToneAudio();
            log('Tone.js 初期化完了。');
        }

        startButton.addEventListener('click', async () => {
            log('テストを開始します...');
            startButton.disabled = true;

            try {
                await initialize();
                await verovioManager.initialize();
                log('VerovioManager 初期化完了。');

                const midiData = await verovioManager.getMidiFromUrl(meiUrl);
                log('VerovioからMIDIデータを取得しました。');

                // SVGデータを取得して表示するロジック
                await verovioManager.displaySvgFromUrl(meiUrl,'scoreSvgContainer');
                log('VerovioからSVGデータを取得し、表示しました。');

                

                // core-processor.jsの修正版を呼び出し、MIDIオブジェクトと拍子記号を取得
                const result = await processMidiData(midiData);
                const midi = result.midi;
                const timeSignature = result.timeSignature;
                
                timeSignatureFromCore = timeSignature; // グローバル変数に保持

                log('core-processorでMIDIデータを解析しました。');

                // 画面にテンポと拍子記号を表示
                document.getElementById('bpmInfo').textContent = midi.header.tempos[0]?.bpm || 'N/A';
                document.getElementById('timeSignatureInfo').textContent = `${timeSignature.beatsPerMeasure}/${timeSignature.subdivision || 4}`;
                document.getElementById('bpmFromCore').textContent = timeSignature.beatsPerMeasure;
                
                log(`MIDIから取得した情報: BPM=${midi.header.tempos[0]?.bpm}, 拍子記号=${timeSignature.beatsPerMeasure}/${timeSignature.subdivision || 4}`);

                convertButton.disabled = false;

            } catch (error) {
                console.error(error);
                log(`エラーが発生しました: ${error.message}`);
            } finally {
                startButton.disabled = false;
            }
        });

        convertButton.addEventListener('click', () => {
            if (!timeSignatureFromCore) {
                log('エラー: 拍子記号情報がありません。先にテストを開始してください。');
                return;
            }

            // play-range.jsを使って計算
            const measure = 3;
            const beat = 0;
            const seconds = measureAndBeatToSeconds(measure, beat, timeSignatureFromCore.beatsPerMeasure);

            log(`計算中: ${measure}小節目の開始位置を計算します...`);
            document.getElementById('resultInfo').textContent = `${seconds.toFixed(2)} 秒`;
            log(`計算結果: ${seconds.toFixed(2)} 秒`);
            
            // おまけ：再生範囲の計算もテスト
            const { startSeconds, durationSeconds } = getPlayRangeInSeconds(2, 4, timeSignatureFromCore.beatsPerMeasure);
            log(`おまけ：2小節目から4小節目までの再生範囲。開始: ${startSeconds.toFixed(2)} 秒, 再生時間: ${durationSeconds.toFixed(2)} 秒`);

        });
    </script>
</body>
</html>