import{loadVerovio as i}from"./loader.min.js";import{CoreProcessor as r}from"./core-processor.min.js";import{ScoreUIHandler as t}from"./score-ui-handler.min.js";import{Transposer as e}from"./transposer.min.js";export class VerovioManager{#a=null;#b=null;#c=null;#d=null;_initPromise=null;async initialize(){return this._initPromise||(this._initPromise=(async()=>{this.#a=await i(),this.#b=new r(this.#a),this.#c=new t,this.#d=new e(this.#a),console.log("VerovioManager initialized")})()),this._initPromise}_ensureInit(){if(!this.#a)throw Error("initialize() を先に呼び出してください。")}setRenderOptions(i){this._ensureInit(),this.#b.setRenderOptions(i)}async displaySvgFromUrl(i,r,{page:t=1,measureRange:e="start-end"}={}){this._ensureInit(),this.#c.showLoading(r);try{let s=await this.#b.renderSvgFromUrl(i,{page:t,measureRange:e});this.#c.displaySvg(s,r)}catch(o){throw console.error("displaySvgFromUrl error:",o),this.#c.showError("楽譜の表示に失敗しました。",r),o}}async getMidiFromUrl(i,{measureRange:r}={}){return(this._ensureInit(),r)?this._getMidiRange(i,r):this.#b.renderMidiFromUrl(i)}async _getMidiRange(i,r){return await this.#b.renderSvgFromUrl(i,{page:1,measureRange:r}),this.#b.renderCurrentMidi()}async displayTransposedSvgFromUrl(i,r,t,{page:e=1,measureRange:s="start-end"}={}){this._ensureInit(),this.#c.showLoading(r);try{let o=await fetch(i);if(!o.ok)throw Error(`MEI fetch failed: ${o.status}`);let n=await o.text(),a=await this.#d.transposeMei(n,t),h=await this.#b.renderSvgFromMei(a,{page:e,measureRange:s});this.#c.displaySvg(h,r)}catch(l){throw console.error("displayTransposedSvgFromUrl error:",l),this.#c.showError("移調表示に失敗しました。",r),l}}}