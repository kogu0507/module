import{loadVerovio as i}from"./loader.min.js";import{CoreProcessor as r}from"./core-processor.min.js";import{ScoreUIHandler as e}from"./score-ui-handler.min.js";import{Transposer as t}from"./transposer.min.js";export class VerovioManager{#a=null;#b=null;#c=null;#d=null;_initPromise=null;async initialize(){return this._initPromise||(this._initPromise=(async()=>{this.#a=await i(),this.#b=new r(this.#a),this.#c=new e,this.#d=new t(this.#a),console.log("VerovioManager initialized")})()),this._initPromise}_ensureInit(){if(!this.#a)throw Error("initialize() を先に呼び出してください。")}setRenderOptions(i){this._ensureInit(),this.#b.setRenderOptions(i)}async _loadMei(i){let r=await fetch(i);if(!r.ok)throw Error(`MEI の取得に失敗 (${r.status})`);return r.text()}async displaySvgFromMei(i,r,{page:e=1,measureRange:t=""}={}){this._ensureInit(),this.#c.showLoading(r);try{let s=await this.#b.renderSvgFromMei(i,{page:e,measureRange:t});this.#c.displaySvg(s,r)}catch(o){throw console.error("displaySvgFromMei error:",o),this.#c.showError("楽譜の表示に失敗しました。",r),o}}async displaySvgFromUrl(i,r,e={page:1,measureRange:""}){let t=await this._loadMei(i);return this.displaySvgFromMei(t,r,e)}async getMidiFromMei(i,{measureRange:r}={}){return(this._ensureInit(),r)?(await this.#b.renderSvgFromMei(i,{page:1,measureRange:r}),this.#b.renderCurrentMidi()):this.#b.renderMidiFromMei(i)}async getMidiFromUrl(i,r={}){let e=await this._loadMei(i);return this.getMidiFromMei(e,r)}async displayTransposedSvgFromMei(i,r,e,{page:t=1,measureRange:s=""}={}){this._ensureInit(),this.#c.showLoading(r);try{let o=await this.#d.transposeMei(i,e),a=await this.#b.renderSvgFromMei(o,{page:t,measureRange:s});this.#c.displaySvg(a,r)}catch(n){throw console.error("displayTransposedSvgFromMei error:",n),this.#c.showError("移調表示に失敗しました。",r),n}}async displayTransposedSvgFromUrl(i,r,e,t={page:1,measureRange:""}){let s=await this._loadMei(i);return this.displayTransposedSvgFromMei(s,r,e,t)}}